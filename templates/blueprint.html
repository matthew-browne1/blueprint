<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link
      href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css"
      rel="stylesheet">
    <link href="https://cdn.datatables.net/v/dt/dt-1.13.4/b-2.3.6/b-colvis-2.3.6/b-html5-2.3.6/cr-1.6.2/date-1.4.1/fc-4.2.2/fh-3.3.2/kt-2.9.0/r-2.4.1/rg-1.3.1/rr-1.3.3/sc-2.1.1/sp-2.1.2/sl-1.6.2/sr-1.2.2/datatables.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/css/editor.dataTables.css">
    <script src="https://kit.fontawesome.com/bcdb575c88.js" crossorigin="anonymous"></script>
  
</head>
<body>

<nav>
    <div class="nav-left">
        <img src="/static/images/RA Logo 1.png" class="logo">
    </div>
    <div class="nav-right">
        <a href= "{{ url_for('export_data') }}" download="{{ current_user.user_info[0].id }}_Input_File.xlsx"class="button-4" id="export-data">Export Data  <i class="fa-solid fa-file-export"></i></a>
        <img src="/static/images/blueprint logo.png" class="logo">
        <div class="nav-user-icon" onclick="settingsMenuToggle()">
            <img src="/static/images/User Login.png">
        </div>
    </div>

    <div class="settings-menu">
        <div id="dark-btn">
            <span></span>
        </div>

        <div class="settings-menu-inner">
            <div class="user-profile">
                <img src="/static/images/User Login.png">
                <div>
                    <p>{{ current_user.user_info[0].full_name }}</p>
                    <a href="#">{{ current_user.user_info[0].email }}</a>
                </div>
            </div>
            <hr>
            <div class="settings-links">
                <img src="/static/images/User Guide.png" class="settings-icon">
                <div>
                    <a href="#">User Guide</a>
                </div>
            </div>
            <div class="settings-links">
                <img src="/static/images/Feedback.png" class="settings-icon">
                <div>
                    <a href="#">Feedback</a>
                </div>
            </div>

            <div class="settings-links">
                <img src="/static/images/Logout.png" class="settings-icon">
                <div>
                    <a href="#">Logout</a>
                </div>
            </div>

        </div>


    </div>
</nav>

   <title>Blueprint</title>

<link rel="stylesheet" href="/static/css/budget_optimiser.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<div class="all-content" id="all-content">

<div class="main-container" id="main-container">
   <div class="results-div" id="results-div">
      <!-- dynamic adding of show results button goes in this div -->
   </div>
   <button type="button" id="col-btn1" class="collapsible active">
      <span id="button-text1">Scenario 1</span>
      <span>&nbsp;</span>
      <span>&nbsp;</span>
      <i class="fa-solid fa-pen-to-square fa-lg" onclick="editButton()"></i>
   </button>
   <script>

   function editButton() {
   var setText = document.getElementById("button-text1");
   var newText = prompt("Rename Tab:")

   if (newText !== null) {
      setText.textContent = newText;
      tabNames[1] = newText;
      }
   }

   </script>
   <div class="content" id="opt-tab1">
      <div class="loading-overlay" id="loading-overlay1">
         <div class="searchLoader">
            <svg id="loading-wheel" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60">
               <style>
              .st0{opacity:0.1;} .st1{opacity:0.33;} .st2{opacity:0.66;}
            </style>
            <path d="M30 0c1 0 1.8.8 1.8 1.8v7.8h-3.6V1.8C28.2.8 29 0 30 0zM1.8 28.2h7.8v3.6H1.8C.8 31.8 0 31 0 30s.8-1.8 1.8-1.8zM9.6 47.8l3.4-3.4 1.3-1.3 2.6 2.6-1.3 1.3-3.4 3.4-.9.9c-.4.4-.8.5-1.3.5s-.9-.2-1.3-.5c-.7-.7-.7-1.8 0-2.6l.9-.9z"/>
            <path class="st0" d="M48.7 8.8c.7-.7 1.8-.7 2.6 0 .7.7.7 1.8 0 2.6l-.9.9-3 3-.4.3-1.3 1.3-2.6-2.6 1.7-1.7 3.9-3.8z"/>
            <path d="M31.8 52.2v6.1c0 1-.8 1.8-1.8 1.8s-1.8-.8-1.8-1.8V50.4h3.6v1.8z"/>
            <path class="st1" d="M50.4 28.2h7.8c1 0 1.8.8 1.8 1.8s-.8 1.8-1.8 1.8h-7.8v-3.6z"/>
            <path d="M10.7 13.3l-1.9-1.9c-.7-.7-.7-1.8 0-2.6.7-.7 1.8-.7 2.6 0l4.3 4.3 1.3 1.3-2.6 2.6-3.7-3.7z"/>
            <path class="st2" d="M47 44.4l.4.4 3 3 .9.9c.7.7.7 1.8 0 2.6-.4.4-.8.5-1.3.5s-.9-.2-1.3-.5l-3.8-3.8-1.7-1.7 2.6-2.6 1.2 1.2z"/>
            </svg>
          </div>
      </div>
      <div class="content-sub">
         <div class="div-above-nav-bar" id="buttons-div1">
           
            <div class="nav-model-left" id="nav-bar">
               <div class="split-nav">
                  <div class="top-half-nav">
                     <div class="obj-func">
                        <div class="dropdown" id="dd-obj1">
                           <div class="select">
                              <span>Select KPI</span>
                              <i class="fa fa-chevron-left"></i>
                           </div>
                           <input type="hidden" name="objective" id="obj-input1">
                           <ul class="dropdown-menu">
                              <li id="profit">Profit</li>
                              <li id="revenue">Revenue</li>
                              <li id="roi">ROI</li>
                           </ul>
                        </div>
                  </div>
                  <div class="blend">       
                     <div class="dropdown" id="dd-blend1">
                        <div class="select">
                           <span>Objective Function</span>
                           <i class="fa fa-chevron-left"></i>
                        </div>
                        <input type="hidden" name="blend" id="blend-input1">
                        <ul class="dropdown-menu">
                           <li id="blend">Blended</li>
                           <li id="st">ST</li>
                           <li id="lt">LT</li>
                        </ul>
                     </div>
                     </div>
                     <div class="exh-bud">       
                        <div class="dropdown" id="dd-exh1">
                           <div class="select">
                              <span>Budget Exhaustion</span>
                              <i class="fa fa-chevron-left"></i>
                           </div>
                           <input type="hidden" name="exhaust-budget" id="exh-input1">
                           <ul class="dropdown-menu">
                              <li id="yes">Exhaust Budget</li>
                              <li id="no">Do Not Exhaust Budget</li>
                           </ul>
                        </div>
                     </div>
               </div>
               <div class="bottom-half-nav">

                  <input type="number" id="max-input1" step="5000" placeholder="Enter Max Budget">

                  <input type="number" id="ftol-input1" step="0.1" placeholder="Enter Tolerance">

                  <input type="number" id="step-size-input1" step="0.1" placeholder="Enter Step-Size">
               </div>
            </div>
               <div class="date-cont" id="date-cont">
                  <div class="date-range-label">
                  <label for="end-date">Date Range Filter:</label>
                  <div class="toggle-button-cover">
                     <div class="button-cover">
                        <div class="button d">
                           <input type="checkbox" class="checkbox" id="date-filter-button1" />
                           <div class="knobs"></div>
                           <div class="layer"></div>
                        </div>
                     </div>
                  </div>
               </div>
                  <div class="date-inputs greyed-out">
                     <input type="date" name="start-date" id="start-date1" class="start-date" placeholder="Start date" />
                     <input type="date" name="end-date" class="end-date" id="end-date1" placeholder="End date" />
                  </div>
               </div>
               <div class="opt-cont-parent" id="opt-button-cont">
                  <button class="button-4" role="button" id="opt-button1">Optimise</button>
               </div>
            </div>
         </div>
         <div class="bo-container" id="channel-container1">
         <table id="channel1" class="hover">
            <thead>
               <tr>
               <th><input type="checkbox" name="select_all" value="1" id="example-select-all" checked></th>
               <th>Region</th>
               <th>Brand</th>
               <th>Channel</th>
               <th>Current Budget</th>
               <th>Min Spend Cap</th>
               <th>Max Spend Cap</th>
               <th>Laydown</th>
               </tr>
            </thead>
         </table>
      </div>
   </div>
   </div>
</div>

<div class="bottom-cont" id="button-cont">
   <i class="fa-solid fa-plus fa-2xl" id="new-tab-button"></i>
   <ol id="optimisation-tabs"></ol>
</div>
<div id="loadPopup" class="popup">
   <div class="popup-content">
      <i class="fa-solid fa-x fa-xl close-icon" id="load-popup-close" onclick="closeLoadPopup()"></i>
      <h2>Choose a Saved Snapshot</h2>
      <div class="saves-cont">
         <table id="load-table" class="display">
            <thead>
            <tr>
               <th>Name</th>
               <th>Table IDs</th>
            </tr>
            </thead>
            <tbody>
            <!-- Rows will be dynamically added here by DataTable -->
            </tbody>
         </table>
      </div>
      <button id="loadButtonPopup" class="button-4" onclick="loadFunc()">Load Snapshot</button>
   </div>
</div>
<div id="savePopup" class="popup">
   <div class="popup-content">
      <i class="fa-solid fa-x fa-xl close-icon" id="save-popup-close" onclick="closeSavePopup()"></i>
      <h2>Overwrite Current Saves</h2>
      <div class="saves-cont">
         <table id="saves-table" class="display">
            <thead>
            <tr>
               <th>Name</th>
               <th>Table IDs</th>
            </tr>
            </thead>
            <tbody>
            <!-- Rows will be dynamically added here by DataTable -->
            </tbody>
         </table>
      </div>
      <div class="save-button-cont">
         <button id="saveButtonPopup" class="button-4" onclick="saveFunc()">Save New Snapshot</button>
         <button id="overwriteSave" class="button-4" onclick="overwriteSave()">Overwrite Existing Snapshot</button>
      </div>
   </div>
</div>
</div>
<div class="button-footer">
   <div class="snapshot-control-cont">
      <button id="save-list" class="button-4">Save Current Snapshot</button>
      <button id="load-list" class="button-4">Load from Saved Snapshots</button> 
   </div>
   <div class="right-buttons">
      <button id="optimise-all" class="button-4">Optimise All</button>
   </div>
</div>
<script>
   tabNames = {1:'Scenario 1'}
   function initializeInitialButton() {
     var content = document.getElementById("opt-tab1");
     var coll = document.getElementById("col-btn1");
     var table = document.getElementById("channel-container1");
     var buttonsDiv = document.getElementById("buttons-div1");
      coll.addEventListener("click", function() {
         this.classList.toggle("active");
         console.log("col-btn"+tabCounter)
         switch(table.style.maxHeight) {
            case "100%":
               table.style.maxHeight = "0%";
               table.style.opacity = 0;
               content.style.maxHeight = buttonsDiv.scrollHeight + "px";
               break
            case "0%":
               table.style.maxHeight = "100%";
               table.style.opacity = 1;
               content.style.maxHeight = "100%";
               break
         }
      });
      table.style.maxHeight = "0%";
      table.style.opacity = 0;
      content.style.maxHeight = buttonsDiv.scrollHeight + "px";
   }

   function initializeCollapsibleButtons(colID) {
     var content = document.getElementById("opt-tab"+colID);
     var coll = document.getElementById("col-btn"+colID);
     var table = document.getElementById("channel-container"+colID);
     var buttonsDiv = document.getElementById("buttons-div"+colID);
     console.log("col-btn"+tabCounter);
     coll.addEventListener("click", function() {
         this.classList.toggle("active");
         console.log("col-btn"+tabCounter)
         switch(table.style.maxHeight) {
            case "100%":
               table.style.maxHeight = "0%";
               table.style.opacity = 0;
               content.style.maxHeight = buttonsDiv.scrollHeight + "px";
               break
            case "0%":
               table.style.maxHeight = "100%";
               table.style.opacity = 1;
               content.style.maxHeight = "100%";
               break
         }
      });
      table.style.maxHeight = "0%";
      table.style.opacity = 0;
      content.style.maxHeight = buttonsDiv.scrollHeight + "px";
     
   }

   function closeButtonTab(tabID) {
      var closeButton = document.getElementById("close-button"+tabID)
      closeButton.addEventListener("click", function() {
         var tab = document.getElementById("new-tab"+tabID);
         $.ajax({
         url: "/channel_delete",
         type: "POST", // You might need to adjust the method based on your backend API
         contentType: "application/json",
         data: JSON.stringify({ "tabID": tabID }),
         success: function (response) {
            console.log("Response from backend:", response);
            // Add any further handling based on the backend response
            sendTableIDsOnRefresh();
            syncTabNames();
         },
         error: function (error) {
            console.error("error deleting tab:", error);
            sendTableIDsOnRefresh();
            syncTabNames();
         },
         });
         tab.remove();
      });
      
   }


   function editButtonTabs(tabID) {
      var setText = document.getElementById("button-text"+tabID);
      var newText = prompt("Rename Tab:")

      if (newText !== null) {
            setText.textContent = newText;
            tabNames[tabID] = newText;
            console.log(tabNames);
         }
      syncTabNames();
   }

   function syncTabNames() {
      $.ajax({
         url: '/get_table_ids',
         method: "GET",
         contentType: "application/json",
         success: function (response) {
            if (response && response.tableIds) {
               var tableIds = response.tableIds;
               const idsToRemove = Object.keys(tabNames).filter((key) => !tableIds.includes(key));
               idsToRemove.forEach((key) => delete tabNames[key]);
               console.log("successfully removed:"+idsToRemove);
            }
         }
      });
   }

   initializeInitialButton();
   var tabCounter;
   function syncTabCounter() {
      $.ajax({
         url: '/sync_tab_counter',
         type: 'GET',
         contentType: "application/json",
         success: function (response) {
            if (response && response.lastNumber) {
               var lastNumber = response.lastNumber;
               tabCounter = lastNumber;
               console.log("tabCounter being set to: ", lastNumber);

            }
         },
         error: function (error) {
            console.error("error fetching last number", error);
         }
      })
   }

   syncTabCounter();
 
   var initialButtonName = document.getElementById("button-text"+tabCounter);
   tabNames[tabCounter] = initialButtonName.textContent;
   console.log(tabNames);
function newTabButtonInit() {
   document.getElementById("new-tab-button").addEventListener("click", function() {
      tabCounter++;
   
       // Clone the HTML content and append it to the document
       var tabContent = document.createElement("div");
       tabContent.setAttribute("id", 'new-tab'+tabCounter);
       tabContent.innerHTML = `
           <button type="button" id="col-btn${tabCounter}" class="collapsible">
            <span id="button-text${tabCounter}">Scenario ${tabCounter}</span>
            <span>&nbsp;</span>
            <span>&nbsp;</span>
            <i class="fa-solid fa-pen-to-square fa-lg" onclick="editButtonTabs(${tabCounter})"></i>
            <i class="fa-solid fa-x fa-xl close-icon" id="close-button${tabCounter}"></i>
         </button>
           <div class="content" id="opt-tab${tabCounter}">
            <div class="loading-overlay" id="loading-overlay${tabCounter}">
               <div class="searchLoader">
                  <svg id="loading-wheel" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60">
                  <style>
                  .st0{opacity:0.1;} .st1{opacity:0.33;} .st2{opacity:0.66;}
                  </style>
                  <path d="M30 0c1 0 1.8.8 1.8 1.8v7.8h-3.6V1.8C28.2.8 29 0 30 0zM1.8 28.2h7.8v3.6H1.8C.8 31.8 0 31 0 30s.8-1.8 1.8-1.8zM9.6 47.8l3.4-3.4 1.3-1.3 2.6 2.6-1.3 1.3-3.4 3.4-.9.9c-.4.4-.8.5-1.3.5s-.9-.2-1.3-.5c-.7-.7-.7-1.8 0-2.6l.9-.9z"/>
                  <path class="st0" d="M48.7 8.8c.7-.7 1.8-.7 2.6 0 .7.7.7 1.8 0 2.6l-.9.9-3 3-.4.3-1.3 1.3-2.6-2.6 1.7-1.7 3.9-3.8z"/>
                  <path d="M31.8 52.2v6.1c0 1-.8 1.8-1.8 1.8s-1.8-.8-1.8-1.8V50.4h3.6v1.8z"/>
                  <path class="st1" d="M50.4 28.2h7.8c1 0 1.8.8 1.8 1.8s-.8 1.8-1.8 1.8h-7.8v-3.6z"/>
                  <path d="M10.7 13.3l-1.9-1.9c-.7-.7-.7-1.8 0-2.6.7-.7 1.8-.7 2.6 0l4.3 4.3 1.3 1.3-2.6 2.6-3.7-3.7z"/>
                  <path class="st2" d="M47 44.4l.4.4 3 3 .9.9c.7.7.7 1.8 0 2.6-.4.4-.8.5-1.3.5s-.9-.2-1.3-.5l-3.8-3.8-1.7-1.7 2.6-2.6 1.2 1.2z"/>
                  </svg>
            </div>
         </div>
      <div class="content-sub">
         <div class="div-above-nav-bar" id="buttons-div${tabCounter}">
               <div class="nav-model-left">
                  <div class="split-nav">
                     <div class="top-half-nav">
                        <div class="obj-func">       
                           <div class="dropdown" id="dd-obj${tabCounter}">
                              <div class="select">
                              <span>Select KPI</span>
                              <i class="fa fa-chevron-left"></i>
                           </div>
                           <input type="hidden" name="objective" id="obj-input${tabCounter}">
                           <ul class="dropdown-menu">
                              <li id="profit">Profit</li>
                              <li id="revenue">Revenue</li>
                              <li id="roi">ROI</li>
                           </ul>
                        </div>
                     </div>
                     <div class="blend">       
                     <div class="dropdown" id="dd-blend${tabCounter}">
                        <div class="select">
                           <span>Objective Function</span>
                           <i class="fa fa-chevron-left"></i>
                        </div>
                        <input type="hidden" name="blend" id="blend-input${tabCounter}">
                        <ul class="dropdown-menu">
                           <li id="blend">Blended</li>
                           <li id="st">ST</li>
                           <li id="lt">LT</li>
                        </ul>
                     </div>
                  </div>
                  <div class="exh-bud">       
                     <div class="dropdown" id="dd-exh${tabCounter}">
                        <div class="select">
                           <span>Budget Exhaustion</span>
                           <i class="fa fa-chevron-left"></i>
                        </div>
                        <input type="hidden" name="exhaust-budget" id="exh-input${tabCounter}">
                        <ul class="dropdown-menu">
                           <li id="yes">Exhaust Budget</li>
                           <li id="no">Do Not Exhaust Budget</li>
                        </ul>
                     </div>
                  </div>
               </div>
               <div class="bottom-half-nav">
                  <input type="number" id="max-input${tabCounter}" step="5000" placeholder="Enter Max Budget">
                  <input type="number" id="ftol-input${tabCounter}" step="0.1" placeholder="Enter Tolerance">
                  <input type="number" id="step-size-input${tabCounter}" step="0.1" placeholder="Enter Step-Size">
               </div>
            </div>
            <div class="date-cont" id="date-cont">
               <div class="date-range-label">
                  <label for="end-date">Date Range Filter:</label>
                  <div class="toggle-button-cover">
                     <div class="button-cover">
                        <div class="button d">
                           <input type="checkbox" class="checkbox" id="date-filter-button${tabCounter}" />
                           <div class="knobs"></div>
                           <div class="layer"></div>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="date-inputs${tabCounter} greyed-out">
                     <input type="date" name="start-date" id="start-date${tabCounter}" class="start-date" placeholder="Start date" />
                     <input type="date" name="end-date" class="end-date" id="end-date${tabCounter}" placeholder="End date" />
                  </div>
                  </div>
                  <div class="opt-cont-parent" id="opt-button-cont">
                     <button class="button-4" role="button" id="opt-button${tabCounter}">Optimise</button>
                  </div>
               </div>
            </div>
            <div class="bo-container" id="channel-container${tabCounter}">
            <table id="channel${tabCounter}" class="hover">
               <thead>
                  <tr>
                     <th><input type="checkbox" name="select_all" value="1" id="example-select-all${tabCounter}" checked></th>
                     <th>Region</th>
                     <th>Brand</th>
                     <th>Channel</th>
                     <th>Current Budget</th>
                     <th>Min Spend Cap</th>
                     <th>Max Spend Cap</th>
                     <th>Laydown</th>
                     </tr>
                  </thead>
               </table>
            </div>
         </div>
      </div>
   </div>
`;
      
       var mainCont = document.getElementById("main-container");
       mainCont.appendChild(tabContent);
       initializeCollapsibleButtons(tabCounter);
       initializeDataTable(tabCounter);
       //initializeButtons(tabCounter);
       closeButtonTab(tabCounter);
       dropdownButtons(tabCounter);
       $(".sparkline").each(function () {
         var $sparkline = $(this);
         var sparklineData = $sparkline.text();
         $sparkline.empty().sparkline(sparklineData, {
            type: "line",
            width: "250px",
         });
      });
      // redrawAllTables(tabCounter);
      var buttonName = document.getElementById("button-text"+tabCounter);
      tabNames[tabCounter] = buttonName.textContent;
      console.log(tabNames);
   });
}
newTabButtonInit();
   </script>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js" integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4" crossorigin="anonymous"></script>
<script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/plug-ins/1.13.6/features/pageResize/dataTables.pageResize.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/select/1.3.3/js/dataTables.select.js"></script>
<script src="static/js/blueprintBaseFunctions.js"></script>
<script type="module" src="static/js/budgetOpt.js"></script>
<script src="static/js/budgetOptTabs.js"></script>
<script src="/static/js/dataTables.editor.js"></script>
<script src="/static/js/editor.dataTables.js"></script>
<script src="https://omnipotent.net/jquery.sparkline/2.1.2/jquery.sparkline.js"></script>
<script src="static/js/saveUI.js"></script>
<script src="/static/js/main.js"></script>
</body>
</html>